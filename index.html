<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programma Giornaliero Lavorazione Frutta - Simone Gatto</title>
    <!-- Importazione librerie esterne -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .header-programma {
            background: linear-gradient(135deg, #2E8B57, #228B22);
            color: white;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #2E8B57;
        }
        
        .section-title {
            color: #2E8B57;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .fornitore-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .fornitore-card:hover {
            border-color: #2E8B57;
            box-shadow: 0 4px 12px rgba(46,139,87,0.15);
        }
        
        .fornitore-card.bio {
            border-color: #dc3545;
            background: #fff5f5;
        }
        
        .fornitore-header {
            background: #2E8B57;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .fornitore-header.bio {
            background: #dc3545;
        }
        
        .btn-programma {
            background: linear-gradient(135deg, #2E8B57, #228B22);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .btn-programma:hover {
            background: linear-gradient(135deg, #228B22, #1e7b1e);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46,139,87,0.3);
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .stats-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .stats-item {
            text-align: center;
            padding: 15px;
        }
        
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2E8B57;
        }
        
        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .time-display {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 5px;
            padding: 8px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .resa-section {
            background: #f0f8ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .destinazione-section {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border-left: 3px solid #2E8B57;
        }
        
        .concentrato-options {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }
        
        .required-field {
            border-left: 3px solid #dc3545 !important;
        }
        
        .bio-text {
            color: #dc3545 !important;
            font-weight: bold !important;
        }
        
        .totali-card {
            background: linear-gradient(135deg, #2E8B57, #228B22);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
        }
        
        .portata-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .portata-btn {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .portata-btn:hover, .portata-btn.active {
            border-color: #2E8B57;
            background: #2E8B57;
            color: white;
        }
    </style>
</head>
<body>
    <div id="programma-container">
        <!-- Header -->
        <div class="header-programma">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO LAVORAZIONE FRUTTA</h1>
                        <h4>Sistema di Gestione Produzione - Simone Gatto</h4>
                        <p class="mb-0">Data: <span id="current-date"></span></p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light btn-lg" onclick="printProgram()">
                            <i class="bi bi-printer"></i> Stampa Programma
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-container">
            <!-- Statistiche Generali -->
            <div class="stats-summary">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stats-item">
                            <div class="stats-value" id="total-giacenza">0</div>
                            <div class="stats-label">Kg Giacenza Totale</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-item">
                            <div class="stats-value" id="total-entrata">0</div>
                            <div class="stats-label">Kg Entrata Giornaliera</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-item">
                            <div class="stats-value" id="total-fornitori">0</div>
                            <div class="stats-label">Fornitori Attivi</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-item">
                            <div class="stats-value" id="tempo-totale">0h</div>
                            <div class="stats-label">Tempo Lavorazione Stimato</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dati Generali Giornata -->
            <div class="section-card">
                <h3 class="section-title"><i class="bi bi-info-circle"></i> Dati Generali Giornata</h3>
                
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Tipo di Agrume</label>
                        <select class="form-select" id="tipo-agrume-generale">
                            <option value="">Seleziona tipo</option>
                            <option value="Limone">Limone</option>
                            <option value="Arancia">Arancia</option>
                            <option value="Mandarino">Mandarino</option>
                            <option value="Pompelmo">Pompelmo</option>
                            <option value="Bergamotto">Bergamotto</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantità Giacenza (kg)</label>
                        <input type="number" class="form-control" id="giacenza-generale" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantità Entrata Totale (kg)</label>
                        <input type="number" class="form-control" id="entrata-totale" placeholder="0" readonly>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Linea di Trasformazione</label>
                        <select class="form-select" id="linea-generale">
                            <option value="">Seleziona linea</option>
                            <option value="BOE/1100">BOE/1100</option>
                            <option value="GOE INT/POLY">GOE INT/POLY</option>
                            <option value="GOE EST/POLY">GOE EST/POLY</option>
                            <option value="GOE EST/400">GOE EST/400</option>
                            <option value="B/SF">B/SF</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Gestione Fornitori -->
            <div class="section-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="section-title mb-0"><i class="bi bi-truck"></i> Gestione Fornitori</h3>
                    <button class="btn btn-programma" onclick="addFornitore()">
                        <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
                    </button>
                </div>
                
                <div id="fornitori-container">
                    <!-- I fornitori verranno aggiunti dinamicamente qui -->
                </div>
            </div>

            <!-- Totali Succo 2^ e Torchiato -->
            <div class="totali-card">
                <h3><i class="bi bi-calculator"></i> Totali Generali Succo 2^ e Torchiato</h3>
                
                <div class="row g-3 mt-3">
                    <div class="col-md-6">
                        <h5>Succo 2^ Spremitura - Totale</h5>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label text-white">Resa Stimata (L)</label>
                                <input type="number" class="form-control" id="succo2-totale-resa" readonly>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label text-white">Destinazione</label>
                                <select class="form-select" id="succo2-totale-destinazione">
                                    <option value="">Seleziona destinazione</option>
                                    <option value="PET 100">PET 100</option>
                                    <option value="PET 200">PET 200</option>
                                    <option value="PET 480">PET 480</option>
                                    <option value="ACMA">ACMA</option>
                                    <option value="REX">REX</option>
                                    <option value="GOGLIO">GOGLIO</option>
                                    <option value="VASCHETTE">VASCHETTE</option>
                                    <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                    <option value="LATTE">LATTE</option>
                                    <option value="F.F.">F.F.</option>
                                    <option value="F.T.C">F.T.C</option>
                                    <option value="FBL">FBL</option>
                                    <option value="BIC">BIC</option>
                                    <option value="CISTERNA P">CISTERNA P</option>
                                    <option value="CISTERNA EF">CISTERNA EF</option>
                                    <option value="CISTERNA VK">CISTERNA VK</option>
                                    <option value="CISTERNA GS">CISTERNA GS</option>
                                    <option value="CONCENTRATO">CONCENTRATO</option>
                                    <option value="ALTRO">ALTRO</option>
                                </select>
                                <div class="concentrato-options" id="succo2-concentrato-options">
                                    <label class="form-label text-dark">Grado BX</label>
                                    <select class="form-select">
                                        <option value="32">32°</option>
                                        <option value="40">40°</option>
                                        <option value="45">45°</option>
                                        <option value="48">48°</option>
                                        <option value="50">50°</option>
                                        <option value="55">55°</option>
                                        <option value="58">58°</option>
                                        <option value="60">60°</option>
                                        <option value="63.5">63,5°</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Torchiato - Totale</h5>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label text-white">Resa Stimata (L)</label>
                                <input type="number" class="form-control" id="torchiato-totale-resa" readonly>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label text-white">Destinazione</label>
                                <select class="form-select" id="torchiato-totale-destinazione">
                                    <option value="">Seleziona destinazione</option>
                                    <option value="PET 100">PET 100</option>
                                    <option value="PET 200">PET 200</option>
                                    <option value="PET 480">PET 480</option>
                                    <option value="ACMA">ACMA</option>
                                    <option value="REX">REX</option>
                                    <option value="GOGLIO">GOGLIO</option>
                                    <option value="VASCHETTE">VASCHETTE</option>
                                    <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                    <option value="LATTE">LATTE</option>
                                    <option value="F.F.">F.F.</option>
                                    <option value="F.T.C">F.T.C</option>
                                    <option value="FBL">FBL</option>
                                    <option value="BIC">BIC</option>
                                    <option value="CISTERNA P">CISTERNA P</option>
                                    <option value="CISTERNA EF">CISTERNA EF</option>
                                    <option value="CISTERNA VK">CISTERNA VK</option>
                                    <option value="CISTERNA GS">CISTERNA GS</option>
                                    <option value="CONCENTRATO">CONCENTRATO</option>
                                    <option value="ALTRO">ALTRO</option>
                                </select>
                                <div class="concentrato-options" id="torchiato-concentrato-options">
                                    <label class="form-label text-dark">Grado BX</label>
                                    <select class="form-select">
                                        <option value="32">32°</option>
                                        <option value="40">40°</option>
                                        <option value="45">45°</option>
                                        <option value="48">48°</option>
                                        <option value="50">50°</option>
                                        <option value="55">55°</option>
                                        <option value="58">58°</option>
                                        <option value="60">60°</option>
                                        <option value="63.5">63,5°</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pulsanti Azione -->
            <div class="text-center mt-4">
                <button class="btn btn-programma btn-lg me-3" onclick="salvaPrograma()">
                    <i class="bi bi-save"></i> Salva Programma
                </button>
                <button class="btn btn-outline-secondary btn-lg me-3" onclick="resetPrograma()">
                    <i class="bi bi-arrow-clockwise"></i> Reset
                </button>
                <button class="btn btn-success btn-lg" onclick="esportaPrograma()">
                    <i class="bi bi-download"></i> Esporta Excel
                </button>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            console.log("Inizializzazione Programma Giornaliero Lavorazione Frutta");
            
            // Imposta la data corrente
            const today = new Date();
            const formattedDate = today.toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            $('#current-date').text(formattedDate);
            
            // Contatore fornitori
            let fornitoreCounter = 0;
            
            // Portate standard per linea (kg/h)
            const portateStandard = {
                'BOE/1100': [800, 1000, 1100, 1200],
                'GOE INT/POLY': [600, 800, 1000],
                'GOE EST/POLY': [600, 800, 1000],
                'GOE EST/400': [300, 350, 400],
                'B/SF': [200, 250, 300, 350]
            };
            
            // Coefficienti di resa standard (%)
            const reseStandard = {
                'Limone': { succo1: 45, succo2: 8, torchiato: 5 },
                'Arancia': { succo1: 50, succo2: 10, torchiato: 6 },
                'Mandarino': { succo1: 42, succo2: 7, torchiato: 4 },
                'Pompelmo': { succo1: 48, succo2: 9, torchiato: 5 },
                'Bergamotto': { succo1: 40, succo2: 6, torchiato: 3 }
            };
            
            // Funzione per aggiungere un nuovo fornitore
            window.addFornitore = function() {
                fornitoreCounter++;
                const fornitoreId = 'fornitore-' + fornitoreCounter;
                
                const fornitoreHtml = `
                    <div class="fornitore-card" id="${fornitoreId}">
                        <div class="fornitore-header">
                            <h5 class="mb-0">Fornitore #${fornitoreCounter}</h5>
                            <button class="btn btn-remove" onclick="removeFornitore('${fornitoreId}')">
                                <i class="bi bi-trash"></i> Rimuovi
                            </button>
                        </div>
                        
                        <div class="row g-3">
                            <!-- Dati Base Fornitore -->
                            <div class="col-md-3">
                                <label class="form-label">Nome Fornitore</label>
                                <select class="form-select fornitore-nome" onchange="updateFornitoreType('${fornitoreId}')">
                                    <option value="">Seleziona fornitore</option>
                                    <option value="RESTUCCIA">RESTUCCIA</option>
                                    <option value="CI">CI</option>
                                    <option value="ARCO">ARCO</option>
                                    <option value="GIOVINAZZO">GIOVINAZZO</option>
                                    <option value="AZ.T.C.">AZ.T.C.</option>
                                    <option value="VASTA">VASTA</option>
                                    <option value="ALTRO">ALTRO</option>
                                </select>
                                <input type="text" class="form-control mt-2 altro-fornitore" placeholder="Specifica altro" style="display:none;">
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">Quantità (kg)</label>
                                <input type="number" class="form-control quantita-fornitore" onchange="calculateTotals()" placeholder="0">
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">Certificazione</label>
                                <select class="form-select certificazione-fornitore" onchange="updateFornitoreStyle('${fornitoreId}')">
                                    <option value="">Seleziona</option>
                                    <option value="BIO EU">BIO EU</option>
                                    <option value="BIO DEM">BIO DEM</option>
                                    <option value="BIO NTD">BIO NTD</option>
                                    <option value="TRACCIATO">TRACCIATO</option>
                                    <option value="IGP">IGP</option>
                                    <option value="CONVENZIONALE">CONVENZIONALE</option>
                                    <option value="ALTRO">ALTRO</option>
                                </select>
                                <input type="text" class="form-control mt-2 altra-certificazione" placeholder="Specifica altra" style="display:none;">
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">Orario Inizio</label>
                                <input type="time" class="form-control orario-inizio" onchange="calculateEndTime('${fornitoreId}')">
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Orario Fine (Calcolato)</label>
                                <input type="text" class="form-control time-display orario-fine" readonly>
                            </div>
                            
                            <!-- Portata Impianto -->
                            <div class="col-md-12">
                                <label class="form-label">Portata Impianto (kg/h)</label>
                                <div class="portata-options" id="portata-${fornitoreId}">
                                    <!-- Le opzioni di portata verranno generate dinamicamente -->
                                </div>
                                <input type="number" class="form-control mt-2 portata-custom" placeholder="Portata personalizzata (kg/h)" onchange="calculateEndTime('${fornitoreId}')">
                            </div>
                            
                            <!-- Sezione Rese -->
                            <div class="col-md-12">
                                <div class="resa-section">
                                    <h6><i class="bi bi-calculator-fill"></i> Calcolo Rese Automatico</h6>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Succo 1^ Spremitura (L)</label>
                                            <input type="number" class="form-control resa-succo1" readonly>
                                            <small class="text-muted">Resa calcolata automaticamente</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Succo 2^ Spremitura (L)</label>
                                            <input type="number" class="form-control resa-succo2" readonly>
                                            <small class="text-muted">Contribuisce al totale generale</small>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Torchiato (L)</label>
                                            <input type="number" class="form-control resa-torchiato" readonly>
                                            <small class="text-muted">Contribuisce al totale generale</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Destinazione Succo 1^ -->
                            <div class="col-md-12">
                                <div class="destinazione-section">
                                    <h6><i class="bi bi-arrow-right-circle"></i> Destinazione Succo 1^ Spremitura</h6>
                                    <div class="row g-2">
                                        <div class="col-md-8">
                                            <select class="form-select destinazione-succo1" onchange="handleDestinazioneChange('${fornitoreId}', 'succo1')">
                                                <option value="">Seleziona destinazione</option>
                                                <option value="PET 100">PET 100</option>
                                                <option value="PET 200">PET 200</option>
                                                <option value="PET 480">PET 480</option>
                                                <option value="ACMA">ACMA</option>
                                                <option value="REX">REX</option>
                                                <option value="GOGLIO">GOGLIO</option>
                                                <option value="VASCHETTE">VASCHETTE</option>
                                                <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                                                <option value="LATTE">LATTE</option>
                                                <option value="F.F.">F.F.</option>
                                                <option value="F.T.C">F.T.C</option>
                                                <option value="FBL">FBL</option>
                                                <option value="BIC">BIC</option>
                                                <option value="CISTERNA P">CISTERNA P</option>
                                                <option value="CISTERNA EF">CISTERNA EF</option>
                                                <option value="CISTERNA VK">CISTERNA VK</option>
                                                <option value="CISTERNA GS">CISTERNA GS</option>
                                                <option value="CONCENTRATO">CONCENTRATO</option>
                                                <option value="ALTRO">ALTRO</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="concentrato-options" id="concentrato-succo1-${fornitoreId}">
                                                <label class="form-label">Grado BX</label>
                                                <select class="form-select grado-bx">
                                                    <option value="32">32°</option>
                                                    <option value="40">40°</option>
                                                    <option value="45">45°</option>
                                                    <option value="48">48°</option>
                                                    <option value="50">50°</option>
                                                    <option value="55">55°</option>
                                                    <option value="58">58°</option>
                                                    <option value="60">60°</option>
                                                    <option value="63.5">63,5°</option>
                                                </select>
                                            </div>
                                            <input type="text" class="form-control altro-destinazione" placeholder="Specifica altra destinazione" style="display:none;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#fornitori-container').append(fornitoreHtml);
                
                // Inizializza le opzioni di portata basate sulla linea generale
                updatePortataOptions(fornitoreId);
                
                // Aggiorna i totali
                calculateTotals();
            };
            
            // Funzione per rimuovere un fornitore
            window.removeFornitore = function(fornitoreId) {
                if (confirm('Sei sicuro di voler rimuovere questo fornitore?')) {
                    $('#' + fornitoreId).remove();
                   calculateTotals();
               }
           };
           
           // Funzione per aggiornare le opzioni di portata
           function updatePortataOptions(fornitoreId) {
               const linea = $('#linea-generale').val();
               const container = $('#portata-' + fornitoreId);
               container.empty();
               
               if (linea && portateStandard[linea]) {
                   portateStandard[linea].forEach(portata => {
                       const btn = $(`
                           <div class="portata-btn" data-portata="${portata}" onclick="selectPortata('${fornitoreId}', ${portata})">
                               ${portata} kg/h
                           </div>
                       `);
                       container.append(btn);
                   });
               }
           }
           
           // Funzione per selezionare una portata
           window.selectPortata = function(fornitoreId, portata) {
               const container = $('#portata-' + fornitoreId);
               container.find('.portata-btn').removeClass('active');
               container.find(`[data-portata="${portata}"]`).addClass('active');
               
               // Imposta la portata nel campo custom
               $('#' + fornitoreId + ' .portata-custom').val(portata);
               
               // Ricalcola l'orario di fine
               calculateEndTime(fornitoreId);
           };
           
           // Funzione per aggiornare il tipo di fornitore
           window.updateFornitoreType = function(fornitoreId) {
               const fornitore = $('#' + fornitoreId + ' .fornitore-nome').val();
               const altroContainer = $('#' + fornitoreId + ' .altro-fornitore');
               
               if (fornitore === 'ALTRO') {
                   altroContainer.show();
               } else {
                   altroContainer.hide().val('');
               }
           };
           
           // Funzione per aggiornare lo stile del fornitore (BIO)
           window.updateFornitoreStyle = function(fornitoreId) {
               const certificazione = $('#' + fornitoreId + ' .certificazione-fornitore').val();
               const fornitoreCard = $('#' + fornitoreId);
               const header = fornitoreCard.find('.fornitore-header');
               const altroContainer = $('#' + fornitoreId + ' .altra-certificazione');
               
               // Gestisci campo "ALTRO"
               if (certificazione === 'ALTRO') {
                   altroContainer.show();
               } else {
                   altroContainer.hide().val('');
               }
               
               // Applica stile BIO
               if (certificazione && (certificazione.includes('BIO') || certificazione === 'BIO EU' || certificazione === 'BIO DEM' || certificazione === 'BIO NTD')) {
                   fornitoreCard.addClass('bio');
                   header.addClass('bio');
               } else {
                   fornitoreCard.removeClass('bio');
                   header.removeClass('bio');
               }
               
               // Ricalcola le rese
               calculateRese(fornitoreId);
           };
           
           // Funzione per calcolare l'orario di fine
           window.calculateEndTime = function(fornitoreId) {
               const quantita = parseFloat($('#' + fornitoreId + ' .quantita-fornitore').val()) || 0;
               const portata = parseFloat($('#' + fornitoreId + ' .portata-custom').val()) || 0;
               const orarioInizio = $('#' + fornitoreId + ' .orario-inizio').val();
               
               if (quantita > 0 && portata > 0 && orarioInizio) {
                   const oreLavorazione = quantita / portata;
                   const minutiLavorazione = Math.round(oreLavorazione * 60);
                   
                   const [ore, minuti] = orarioInizio.split(':').map(Number);
                   const inizioDate = new Date();
                   inizioDate.setHours(ore, minuti, 0, 0);
                   
                   const fineDate = new Date(inizioDate.getTime() + minutiLavorazione * 60000);
                   
                   const orarioFine = fineDate.toTimeString().slice(0, 5);
                   $('#' + fornitoreId + ' .orario-fine').val(orarioFine);
                   
                   // Aggiorna anche il tempo totale
                   updateTempoTotale();
               } else {
                   $('#' + fornitoreId + ' .orario-fine').val('');
               }
               
               // Ricalcola le rese
               calculateRese(fornitoreId);
           };
           
           // Funzione per calcolare le rese
           function calculateRese(fornitoreId) {
               const tipoAgrume = $('#tipo-agrume-generale').val();
               const quantita = parseFloat($('#' + fornitoreId + ' .quantita-fornitore').val()) || 0;
               
               if (tipoAgrume && quantita > 0 && reseStandard[tipoAgrume]) {
                   const rese = reseStandard[tipoAgrume];
                   
                   const succo1 = Math.round((quantita * rese.succo1) / 100);
                   const succo2 = Math.round((quantita * rese.succo2) / 100);
                   const torchiato = Math.round((quantita * rese.torchiato) / 100);
                   
                   $('#' + fornitoreId + ' .resa-succo1').val(succo1);
                   $('#' + fornitoreId + ' .resa-succo2').val(succo2);
                   $('#' + fornitoreId + ' .resa-torchiato').val(torchiato);
                   
                   // Aggiorna i totali generali
                   updateTotaliGenerali();
               }
           }
           
           // Funzione per gestire il cambio di destinazione
           window.handleDestinazioneChange = function(fornitoreId, tipo) {
               const destinazione = $('#' + fornitoreId + ' .destinazione-' + tipo).val();
               const concentratoContainer = $('#concentrato-' + tipo + '-' + fornitoreId);
               const altroContainer = $('#' + fornitoreId + ' .altro-destinazione');
               
               if (destinazione === 'CONCENTRATO') {
                   concentratoContainer.show();
               } else {
                   concentratoContainer.hide();
               }
               
               if (destinazione === 'ALTRO') {
                   altroContainer.show();
               } else {
                   altroContainer.hide().val('');
               }
           };
           
           // Funzione per aggiornare i totali generali di succo 2^ e torchiato
           function updateTotaliGenerali() {
               let totaleSucco2 = 0;
               let totaleTorchiato = 0;
               
               $('.resa-succo2').each(function() {
                   totaleSucco2 += parseFloat($(this).val()) || 0;
               });
               
               $('.resa-torchiato').each(function() {
                   totaleTorchiato += parseFloat($(this).val()) || 0;
               });
               
               $('#succo2-totale-resa').val(totaleSucco2);
               $('#torchiato-totale-resa').val(totaleTorchiato);
           }
           
           // Funzione per calcolare i totali
           function calculateTotals() {
               let totaleEntrata = 0;
               let totaleFornitori = 0;
               
               $('.quantita-fornitore').each(function() {
                   const quantita = parseFloat($(this).val()) || 0;
                   if (quantita > 0) {
                       totaleEntrata += quantita;
                       totaleFornitori++;
                   }
               });
               
               $('#total-entrata').text(totaleEntrata.toLocaleString());
               $('#entrata-totale').val(totaleEntrata);
               $('#total-fornitori').text(totaleFornitori);
               
               // Aggiorna giacenza totale
               const giacenza = parseFloat($('#giacenza-generale').val()) || 0;
               $('#total-giacenza').text((giacenza + totaleEntrata).toLocaleString());
               
               // Aggiorna totali rese
               updateTotaliGenerali();
           }
           
           // Funzione per aggiornare il tempo totale di lavorazione
           function updateTempoTotale() {
               let tempoTotaleMinuti = 0;
               
               $('.fornitore-card').each(function() {
                   const quantita = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
                   const portata = parseFloat($(this).find('.portata-custom').val()) || 0;
                   
                   if (quantita > 0 && portata > 0) {
                       const tempoLavorazione = (quantita / portata) * 60; // in minuti
                       tempoTotaleMinuti += tempoLavorazione;
                   }
               });
               
               const ore = Math.floor(tempoTotaleMinuti / 60);
               const minuti = Math.round(tempoTotaleMinuti % 60);
               $('#tempo-totale').text(ore + 'h ' + (minuti > 0 ? minuti + 'm' : ''));
           }
           
           // Event listeners per aggiornamenti automatici
           $('#tipo-agrume-generale').change(function() {
               $('.fornitore-card').each(function() {
                   const fornitoreId = $(this).attr('id');
                   calculateRese(fornitoreId);
               });
           });
           
           $('#linea-generale').change(function() {
               $('.fornitore-card').each(function() {
                   const fornitoreId = $(this).attr('id');
                   updatePortataOptions(fornitoreId);
               });
           });
           
           $('#giacenza-generale').on('input', function() {
               calculateTotals();
           });
           
           // Gestione destinazioni totali
           $('#succo2-totale-destinazione').change(function() {
               if ($(this).val() === 'CONCENTRATO') {
                   $('#succo2-concentrato-options').show();
               } else {
                   $('#succo2-concentrato-options').hide();
               }
           });
           
           $('#torchiato-totale-destinazione').change(function() {
               if ($(this).val() === 'CONCENTRATO') {
                   $('#torchiato-concentrato-options').show();
               } else {
                   $('#torchiato-concentrato-options').hide();
               }
           });
           
           // Funzioni per i pulsanti principali
           window.salvaPrograma = function() {
               // Validazione base
               const tipoAgrume = $('#tipo-agrume-generale').val();
               const linea = $('#linea-generale').val();
               
               if (!tipoAgrume || !linea) {
                   alert('Selezionare tipo di agrume e linea di trasformazione prima di salvare');
                   return;
               }
               
               if ($('.fornitore-card').length === 0) {
                   alert('Aggiungere almeno un fornitore prima di salvare');
                   return;
               }
               
               // Crea oggetto dati programma
               const programmaData = {
                   data: new Date().toISOString().split('T')[0],
                   tipoAgrume: tipoAgrume,
                   giacenza: $('#giacenza-generale').val(),
                   lineaTrasformazione: linea,
                   fornitori: [],
                   totali: {
                       entrata: $('#total-entrata').text(),
                       giacenzaTotale: $('#total-giacenza').text(),
                       tempoTotale: $('#tempo-totale').text(),
                       succo2Totale: $('#succo2-totale-resa').val(),
                       torchiatoTotale: $('#torchiato-totale-resa').val()
                   }
               };
               
               // Raccogli dati fornitori
               $('.fornitore-card').each(function() {
                   const fornitore = {
                       nome: $(this).find('.fornitore-nome').val(),
                       quantita: $(this).find('.quantita-fornitore').val(),
                       certificazione: $(this).find('.certificazione-fornitore').val(),
                       orarioInizio: $(this).find('.orario-inizio').val(),
                       orarioFine: $(this).find('.orario-fine').val(),
                       portata: $(this).find('.portata-custom').val(),
                       rese: {
                           succo1: $(this).find('.resa-succo1').val(),
                           succo2: $(this).find('.resa-succo2').val(),
                           torchiato: $(this).find('.resa-torchiato').val()
                       },
                       destinazioneSucco1: $(this).find('.destinazione-succo1').val()
                   };
                   programmaData.fornitori.push(fornitore);
               });
               
               // Salva nel localStorage
               localStorage.setItem('programmaGiornaliero_' + new Date().toISOString().split('T')[0], JSON.stringify(programmaData));
               
               alert('Programma salvato con successo!');
           };
           
           window.resetPrograma = function() {
               if (confirm('Sei sicuro di voler resettare tutto il programma? Tutti i dati verranno persi.')) {
                   $('#fornitori-container').empty();
                   $('.form-control, .form-select').val('');
                   $('#total-entrata, #total-giacenza, #total-fornitori, #tempo-totale').text('0');
                   $('#succo2-totale-resa, #torchiato-totale-resa').val('');
                   fornitoreCounter = 0;
                   alert('Programma resettato con successo!');
               }
           };
           
           window.printProgram = function() {
               window.print();
           };
           
           window.esportaPrograma = function() {
               // Simula esportazione Excel
               const data = {
                   tipoAgrume: $('#tipo-agrume-generale').val(),
                   giacenza: $('#giacenza-generale').val(),
                   fornitori: $('.fornitore-card').length,
                   entrataTotale: $('#total-entrata').text()
               };
               
               alert('Esportazione Excel simulata:\n' + JSON.stringify(data, null, 2));
           };
           
           // Inizializza con un fornitore di esempio
           addFornitore();
           
           console.log("Programma Giornaliero Lavorazione Frutta inizializzato con successo");
       });
   </script>

   <!-- Stili per la stampa -->
   <style media="print">
       .btn, .nav-button { display: none !important; }
       .header-programma { background: #2E8B57 !important; }
       .fornitore-header { background: #2E8B57 !important; }
       .totali-card { background: #2E8B57 !important; }
       body { font-size: 12px; }
       .section-card { page-break-inside: avoid; }
   </style>
</body>
</html>
