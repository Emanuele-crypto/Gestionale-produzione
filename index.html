<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programma Giornaliero Lavorazione Frutta - Simone Gatto</title>
    <!-- Importazione librerie esterne -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .header-programma {
            background: linear-gradient(135deg, #2E8B57, #228B22);
            color: white;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .container-main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .section-card {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background-color: #fafafa;
            border-left: 4px solid #2E8B57;
        }
        
        .section-title {
            background: linear-gradient(90deg, #2E8B57, #32CD32);
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .form-label-required::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }
        
        .calculated-field {
            background-color: #e9f7ef !important;
            border: 2px solid #28a745 !important;
            font-weight: bold;
        }
        
        .btn-programma {
            background: linear-gradient(135deg, #2E8B57, #228B22);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .btn-programma:hover {
            background: linear-gradient(135deg, #228B22, #2E8B57);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }
        
        .progress-bar-custom {
            height: 25px;
            border-radius: 12px;
            background: linear-gradient(90deg, #32CD32, #228B22);
        }
        
        .input-group-text {
            background-color: #2E8B57;
            color: white;
            border-color: #2E8B57;
        }
        
        .table-programma {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .table-programma thead {
            background: linear-gradient(90deg, #2E8B57, #228B22);
        }
        
        .bio-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        
        .alert-programma {
            border-left: 4px solid #2E8B57;
            background-color: #e8f5e8;
            border-color: #2E8B57;
        }
        
        .fornitore-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .fornitore-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
        }
        
        .summary-card {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2E8B57;
        }
        
        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2E8B57;
        }
    </style>
</head>
<body>
    <div class="header-programma">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO LAVORAZIONE FRUTTA</h1>
                    <h4>Sistema di Pianificazione e Controllo Produzione</h4>
                    <p class="mb-0">Data: <span id="current-date"></span> | Turno: <span id="current-shift"></span></p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button class="btn btn-light" id="btn-export-pdf">
                            <i class="bi bi-file-pdf"></i> Esporta PDF
                        </button>
                        <button class="btn btn-light" id="btn-print">
                            <i class="bi bi-printer"></i> Stampa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-main">
        <!-- Sezione Configurazione Giornata -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-gear"></i> Configurazione Giornata di Lavorazione
            </div>
            
            <form id="config-form">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="data-lavorazione" class="form-label form-label-required">Data Lavorazione</label>
                        <input type="date" class="form-control" id="data-lavorazione" required>
                    </div>
                    <div class="col-md-3">
                        <label for="turno" class="form-label form-label-required">Turno</label>
                        <select class="form-select" id="turno" required>
                            <option value="">Seleziona turno</option>
                            <option value="Mattino (06:00-14:00)">Mattino (06:00-14:00)</option>
                            <option value="Pomeriggio (14:00-22:00)">Pomeriggio (14:00-22:00)</option>
                            <option value="Notte (22:00-06:00)">Notte (22:00-06:00)</option>
                            <option value="Continuo (24h)">Continuo (24h)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="responsabile" class="form-label form-label-required">Responsabile Turno</label>
                        <input type="text" class="form-control" id="responsabile" placeholder="Nome responsabile" required>
                    </div>
                    <div class="col-md-3">
                        <label for="note-giornata" class="form-label">Note Giornata</label>
                        <input type="text" class="form-control" id="note-giornata" placeholder="Note particolari">
                    </div>
                </div>
            </form>
        </div>

        <!-- Sezione Tipo Agrume e Giacenze -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-box"></i> Gestione Giacenze e Prodotto in Entrata
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3">Tipo di Agrume da Lavorare</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="tipo-agrume-principale" class="form-label form-label-required">Tipo Agrume Principale</label>
                            <select class="form-select" id="tipo-agrume-principale" required>
                                <option value="">Seleziona tipo agrume</option>
                                <option value="LIMONE">LIMONE</option>
                                <option value="ARANCIA">ARANCIA</option>
                                <option value="MANDARINO">MANDARINO</option>
                                <option value="POMPELMO">POMPELMO</option>
                                <option value="BERGAMOTTO">BERGAMOTTO</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="varieta-agrume" class="form-label">Varietà</label>
                            <select class="form-select" id="varieta-agrume">
                                <option value="">Seleziona varietà</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <h6 class="mb-3">Quantità e Giacenze</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="giacenza-totale" class="form-label">Giacenza Totale (kg)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="giacenza-totale" min="0">
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="entrata-giornaliera" class="form-label form-label-required">Entrata Giornaliera (kg)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="entrata-giornaliera" min="0" required>
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-12">
                    <div class="summary-card">
                        <h6>Quantità Totale Disponibile</h6>
                        <div class="summary-value" id="totale-disponibile">0 kg</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Fornitori -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-truck"></i> Gestione Fornitori e Entrate
            </div>
            
            <div id="fornitori-container">
                <div class="fornitore-card" data-fornitore="1">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label form-label-required">Nome Fornitore</label>
                            <select class="form-select fornitore-select" required>
                                <option value="">Seleziona fornitore</option>
                                <option value="RESTUCCIA">RESTUCCIA</option>
                                <option value="CI">CI</option>
                                <option value="ARCO">ARCO</option>
                                <option value="GIOVINAZZO">GIOVINAZZO</option>
                                <option value="AZ.T.C.">AZ.T.C.</option>
                                <option value="VASTA">VASTA</option>
                                <option value="ALTRO">ALTRO</option>
                            </select>
                            <input type="text" class="form-control mt-2 altro-fornitore" placeholder="Specifica altro fornitore" style="display: none;">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-required">Quantità (kg)</label>
                            <div class="input-group">
                                <input type="number" class="form-control quantita-fornitore" min="0" required>
                                <span class="input-group-text">kg</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label form-label-required">Tipologia Prodotto</label>
                            <select class="form-select tipologia-prodotto" required>
                                <option value="">Seleziona tipologia</option>
                                <option value="BIO EU">BIO EU</option>
                                <option value="BIO DEM">BIO DEM</option>
                                <option value="BIO NTD">BIO NTD</option>
                                <option value="TRACCIATO">TRACCIATO</option>
                                <option value="IGP">IGP</option>
                                <option value="CONVENZIONALE">CONVENZIONALE</option>
                                <option value="ALTRO">ALTRO</option>
                            </select>
                            <input type="text" class="form-control mt-2 altra-tipologia" placeholder="Specifica altra tipologia" style="display: none;">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Targa Mezzo</label>
                            <input type="text" class="form-control targa-mezzo" placeholder="AA123BB">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-fornitore">
                                <i class="bi bi-trash"></i> Rimuovi
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-success" id="add-fornitore">
                        <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
                    </button>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="alert alert-programma">
                        <strong>Totale da Fornitori: </strong><span id="totale-fornitori" class="fw-bold">0 kg</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert alert-warning" id="differenza-alert" style="display: none;">
                        <strong>Differenza: </strong><span id="differenza-valore" class="fw-bold"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Linea di Trasformazione -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-gear-wide-connected"></i> Configurazione Linea di Trasformazione
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="linea-trasformazione" class="form-label form-label-required">Linea di Trasformazione</label>
                    <select class="form-select" id="linea-trasformazione" required>
                        <option value="">Seleziona linea</option>
                        <option value="BOE/1100">BOE/1100</option>
                        <option value="GOE INT/POLY">GOE INT/POLY</option>
                        <option value="GOE EST/POLY">GOE EST/POLY</option>
                        <option value="GOE EST/400">GOE EST/400</option>
                        <option value="B/SF">B/SF</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="portata-impianto" class="form-label form-label-required">Portata Impianto (kg/h)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="portata-impianto" min="1" required>
                        <span class="input-group-text">kg/h</span>
                    </div>
                </div>
                <div class="col-md-4">
                    <label for="quantita-da-lavorare" class="form-label form-label-required">Quantità da Lavorare (kg)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="quantita-da-lavorare" min="1" required>
                        <span class="input-group-text">kg</span>
                    </div>
                </div>
            </div>
            
            <div class="row g-3 mt-3">
                <div class="col-md-4">
                    <label for="orario-inizio" class="form-label form-label-required">Orario Inizio Lavorazione</label>
                    <input type="time" class="form-control" id="orario-inizio" required>
                </div>
                <div class="col-md-4">
                    <label for="durata-lavorazione" class="form-label">Durata Stimata</label>
                    <input type="text" class="form-control calculated-field" id="durata-lavorazione" readonly placeholder="Calcolato automaticamente">
                </div>
                <div class="col-md-4">
                    <label for="orario-fine" class="form-label">Orario Fine Stimato</label>
                    <input type="time" class="form-control calculated-field" id="orario-fine" readonly>
                </div>
            </div>
        </div>

        <!-- Sezione Rese Spremiture -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-droplet"></i> Calcolo Automatico Rese Spremiture
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <h6 class="text-center mb-3">Prima Spremitura</h6>
                    <div class="mb-3">
                        <label for="resa-prima-perc" class="form-label">Resa % Stimata</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="resa-prima-perc" min="0" max="100" step="0.1" value="45">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="resa-prima-litri" class="form-label">Resa Stimata (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control calculated-field" id="resa-prima-litri" readonly>
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="resa-prima-effettiva" class="form-label">Resa Effettiva (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="resa-prima-effettiva" min="0">
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h6 class="text-center mb-3">Seconda Spremitura</h6>
                    <div class="mb-3">
                        <label for="resa-seconda-perc" class="form-label">Resa % Stimata</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="resa-seconda-perc" min="0" max="100" step="0.1" value="25">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="resa-seconda-litri" class="form-label">Resa Stimata (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control calculated-field" id="resa-seconda-litri" readonly>
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="resa-seconda-effettiva" class="form-label">Resa Effettiva (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="resa-seconda-effettiva" min="0">
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h6 class="text-center mb-3">Torchiato</h6>
                    <div class="mb-3">
                        <label for="resa-torchiato-perc" class="form-label">Resa % Stimata</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="resa-torchiato-perc" min="0" max="100" step="0.1" value="15">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="resa-torchiato-litri" class="form-label">Resa Stimata (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control calculated-field" id="resa-torchiato-litri" readonly>
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="resa-torchiato-effettiva" class="form-label">Resa Effettiva (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="resa-torchiato-effettiva" min="0">
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="summary-card">
                        <h6>Resa Totale Stimata</h6>
                        <div class="summary-value" id="resa-totale">0 L</div>
                        <small class="text-muted">Percentuale totale: <span id="resa-totale-perc">0%</span></small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sezione Destinazione Spremiture -->
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-arrow-right-square"></i> Destinazione Spremiture
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <h6 class="mb-3">Prima Spremitura</h6>
                    <div class="mb-3">
                        <label for="dest-prima" class="form-label form-label-required">Destinazione</label>
                        <select class="form-select destinazione-select" id="dest-prima" required>
                            <option value="">Seleziona destinazione</option>
                            <option value="PET 100">PET 100</option>
                            <option value="PET 200">PET 200</option>
                            <option value="PET 480">PET 480</option>
                            <option value="ACMA">ACMA</option>
                            <option value="REX">REX</option>
                            <option value="GOGLIO">GOGLIO</option>
                            <option value="VASCHETTE">VASCHETTE</option>
                            <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                            <option value="LATTE">LATTE</option>
                            <option value="F.F.">F.F.</option>
                            <option value="F.T.C">F.T.C</option>
                            <option value="FBL">FBL</option>
                            <option value="BIC">BIC</option>
                            <option value="CISTERNA P">CISTERNA P</option>
                            <option value="CISTERNA EF">CISTERNA EF</option>
                            <option value="CISTERNA VK">CISTERNA VK</option>
                            <option value="CISTERNA GS">CISTERNA GS</option>
                            <option value="ALTRO">ALTRO (SPECIFICARE)</option>
                        </select>
                        <input type="text" class="form-control mt-2 altra-dest" placeholder="Specifica altra destinazione" style="display: none;">
                    </div>
                    <div class="mb-3">
                        <label for="quantita-dest-prima" class="form-label">Quantità Destinata (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="quantita-dest-prima" min="0">
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h6 class="mb-3">Seconda Spremitura</h6>
                    <div class="mb-3">
                        <label for="dest-seconda" class="form-label form-label-required">Destinazione</label>
                        <select class="form-select destinazione-select" id="dest-seconda" required>
                            <option value="">Seleziona destinazione</option>
                            <option value="PET 100">PET 100</option>
                            <option value="PET 200">PET 200</option>
                            <option value="PET 480">PET 480</option>
                            <option value="ACMA">ACMA</option>
                            <option value="REX">REX</option>
                            <option value="GOGLIO">GOGLIO</option>
                            <option value="VASCHETTE">VASCHETTE</option>
                            <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                            <option value="LATTE">LATTE</option>
                            <option value="F.F.">F.F.</option>
                            <option value="F.T.C">F.T.C</option>
                            <option value="FBL">FBL</option>
                            <option value="BIC">BIC</option>
                            <option value="CISTERNA P">CISTERNA P</option>
                            <option value="CISTERNA EF">CISTERNA EF</option>
                            <option value="CISTERNA VK">CISTERNA VK</option>
                            <option value="CISTERNA GS">CISTERNA GS</option>
                            <option value="ALTRO">ALTRO (SPECIFICARE)</option>
                        </select>
                        <input type="text" class="form-control mt-2 altra-dest" placeholder="Specifica altra destinazione" style="display: none;">
                    </div>
                    <div class="mb-3">
                        <label for="quantita-dest-seconda" class="form-label">Quantità Destinata (L)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="quantita-dest-seconda" min="0">
                            <span class="input-group-text">L</span>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h6 class="mb-3">Torchiato</h6>
                    <div class="mb-3">
                        <label for="dest-torchiato" class="form-label form-label-required">Destinazione</label>
                        <select class="form-select destinazione-select" id="dest-torchiato" required>
                            <option value="">Seleziona destinazione</option>
                            <option value="PET 100">PET 100</option>
                            <option value="PET 200">PET 200</option>
                            <option value="PET 480">PET 480</option>
                            <option value="ACMA">ACMA</option>
                            <option value="REX">REX</option>
                            <option value="GOGLIO">GOGLIO</option>
                                <option value="VASCHETTE">VASCHETTE</option>
                           <option value="VASCHETTE ZUCCHERATE">VASCHETTE ZUCCHERATE</option>
                           <option value="LATTE">LATTE</option>
                           <option value="F.F.">F.F.</option>
                           <option value="F.T.C">F.T.C</option>
                           <option value="FBL">FBL</option>
                           <option value="BIC">BIC</option>
                           <option value="CISTERNA P">CISTERNA P</option>
                           <option value="CISTERNA EF">CISTERNA EF</option>
                           <option value="CISTERNA VK">CISTERNA VK</option>
                           <option value="CISTERNA GS">CISTERNA GS</option>
                           <option value="ALTRO">ALTRO (SPECIFICARE)</option>
                       </select>
                       <input type="text" class="form-control mt-2 altra-dest" placeholder="Specifica altra destinazione" style="display: none;">
                   </div>
                   <div class="mb-3">
                       <label for="quantita-dest-torchiato" class="form-label">Quantità Destinata (L)</label>
                       <div class="input-group">
                           <input type="number" class="form-control" id="quantita-dest-torchiato" min="0">
                           <span class="input-group-text">L</span>
                       </div>
                   </div>
               </div>
           </div>
       </div>

       <!-- Sezione Riepilogo e Controlli -->
       <div class="section-card">
           <div class="section-title">
               <i class="bi bi-clipboard-check"></i> Riepilogo Programma di Lavorazione
           </div>
           
           <div class="row g-4">
               <div class="col-md-6">
                   <div class="table-responsive">
                       <table class="table table-programma table-striped">
                           <thead class="text-white">
                               <tr>
                                   <th>Parametro</th>
                                   <th>Valore</th>
                               </tr>
                           </thead>
                           <tbody id="riepilogo-table">
                               <!-- Dati generati dinamicamente -->
                           </tbody>
                       </table>
                   </div>
               </div>
               
               <div class="col-md-6">
                   <h6>Stato Avanzamento</h6>
                   <div class="mb-3">
                       <label>Completamento Configurazione</label>
                       <div class="progress">
                           <div class="progress-bar progress-bar-custom" role="progressbar" id="progress-config" style="width: 0%">
                               0%
                           </div>
                       </div>
                   </div>
                   
                   <div class="mb-3">
                       <label>Bilanciamento Fornitori</label>
                       <div class="progress">
                           <div class="progress-bar progress-bar-custom" role="progressbar" id="progress-fornitori" style="width: 0%">
                               0%
                           </div>
                       </div>
                   </div>
                   
                   <div class="alert alert-info">
                       <strong>Stato Sistema:</strong> <span id="stato-sistema">In configurazione</span><br>
                       <strong>Ultimo Aggiornamento:</strong> <span id="ultimo-aggiornamento" class="time-display">--:--</span>
                   </div>
               </div>
           </div>
       </div>

       <!-- Pulsanti di Azione -->
       <div class="section-card">
           <div class="section-title">
               <i class="bi bi-tools"></i> Azioni Programma
           </div>
           
           <div class="row g-3">
               <div class="col-md-3">
                   <button type="button" class="btn btn-programma w-100" id="btn-salva-programma">
                       <i class="bi bi-save"></i> Salva Programma
                   </button>
               </div>
               <div class="col-md-3">
                   <button type="button" class="btn btn-outline-success w-100" id="btn-avvia-lavorazione">
                       <i class="bi bi-play-circle"></i> Avvia Lavorazione
                   </button>
               </div>
               <div class="col-md-3">
                   <button type="button" class="btn btn-outline-warning w-100" id="btn-reset-programma">
                       <i class="bi bi-arrow-clockwise"></i> Reset Programma
                   </button>
               </div>
               <div class="col-md-3">
                   <button type="button" class="btn btn-outline-primary w-100" id="btn-carica-template">
                       <i class="bi bi-upload"></i> Carica Template
                   </button>
               </div>
           </div>
       </div>

       <!-- Sezione Storico Lavorazioni -->
       <div class="section-card">
           <div class="section-title">
               <i class="bi bi-clock-history"></i> Storico Lavorazioni Recenti
           </div>
           
           <div class="table-responsive">
               <table class="table table-programma table-hover">
                   <thead class="text-white">
                       <tr>
                           <th>Data</th>
                           <th>Turno</th>
                           <th>Agrume</th>
                           <th>Quantità (kg)</th>
                           <th>Linea</th>
                           <th>Durata</th>
                           <th>Resa (%)</th>
                           <th>Stato</th>
                           <th>Azioni</th>
                       </tr>
                   </thead>
                   <tbody id="storico-table">
                       <!-- Dati storici generati dinamicamente -->
                   </tbody>
               </table>
           </div>
       </div>
   </div>

   <!-- Modal per Conferma Azioni -->
   <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
       <div class="modal-dialog">
           <div class="modal-content">
               <div class="modal-header">
                   <h5 class="modal-title" id="confirmModalLabel">Conferma Azione</h5>
                   <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body" id="confirmModalBody">
                   <!-- Contenuto dinamico -->
               </div>
               <div class="modal-footer">
                   <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                   <button type="button" class="btn btn-programma" id="confirmActionBtn">Conferma</button>
               </div>
           </div>
       </div>
   </div>

   <!-- JavaScript -->
   <script>
       $(document).ready(function() {
           console.log("Programma Giornaliero Lavorazione Frutta - Inizializzazione...");

           // ================ VARIABILI GLOBALI ================
           let programmaData = {
               config: {},
               fornitori: [],
               lavorazione: {},
               rese: {},
               destinazioni: {},
               stato: 'configurazione'
           };

           let storicoLavorazioni = [];
           let fornitoreCounter = 1;

           // ================ INIZIALIZZAZIONE ================
           function inizializzaInterface() {
               // Imposta data corrente
               const oggi = new Date();
               const dataFormattata = oggi.toISOString().split('T')[0];
               $("#data-lavorazione").val(dataFormattata);
               $("#current-date").text(oggi.toLocaleDateString('it-IT'));
               
               // Determina turno corrente
               const ora = oggi.getHours();
               let turnoCorrente;
               if (ora >= 6 && ora < 14) {
                   turnoCorrente = "Mattino (06:00-14:00)";
               } else if (ora >= 14 && ora < 22) {
                   turnoCorrente = "Pomeriggio (14:00-22:00)";
               } else {
                   turnoCorrente = "Notte (22:00-06:00)";
               }
               $("#turno").val(turnoCorrente);
               $("#current-shift").text(turnoCorrente);

               // Aggiorna timestamp
               aggiornaTimestamp();
               setInterval(aggiornaTimestamp, 30000); // Aggiorna ogni 30 secondi

               // Carica dati demo
               caricaDatiDemo();
               
               console.log("Interface inizializzata con successo");
           }

           function aggiornaTimestamp() {
               const ora = new Date().toLocaleTimeString('it-IT');
               $("#ultimo-aggiornamento").text(ora);
           }

           // ================ GESTIONE TIPO AGRUME E VARIETÀ ================
           $("#tipo-agrume-principale").change(function() {
               const tipoAgrume = $(this).val();
               const varietaSelect = $("#varieta-agrume");
               
               varietaSelect.empty().append('<option value="">Seleziona varietà</option>');
               
               const varieta = {
                   'LIMONE': ['Verdello', 'Femminello', 'Interdonato', 'Monachello'],
                   'ARANCIA': ['Tarocco', 'Moro', 'Sanguinello', 'Valencia', 'Navel'],
                   'MANDARINO': ['Ciaculli', 'Tardivo di Ciaculli', 'Avana', 'Clementine'],
                   'POMPELMO': ['Rosa', 'Bianco', 'Star Ruby'],
                   'BERGAMOTTO': ['Femminello', 'Castagnaro', 'Fantastico']
               };
               
               if (varieta[tipoAgrume]) {
                   varieta[tipoAgrume].forEach(function(v) {
                       varietaSelect.append(`<option value="${v}">${v}</option>`);
                   });
               }
               
               calcolaQuantitaTotale();
               aggiornaRiepilogo();
           });

           // ================ CALCOLI AUTOMATICI ================
           function calcolaQuantitaTotale() {
               const giacenza = parseFloat($("#giacenza-totale").val()) || 0;
               const entrata = parseFloat($("#entrata-giornaliera").val()) || 0;
               const totale = giacenza + entrata;
               
               $("#totale-disponibile").text(totale.toLocaleString('it-IT') + " kg");
               
               // Aggiorna anche la quantità da lavorare se non è stata impostata manualmente
               if (!$("#quantita-da-lavorare").val()) {
                   $("#quantita-da-lavorare").val(entrata);
               }
               
               calcolaDurataLavorazione();
               calcolaReseSpremitura();
           }

           function calcolaDurataLavorazione() {
               const portata = parseFloat($("#portata-impianto").val()) || 0;
               const quantita = parseFloat($("#quantita-da-lavorare").val()) || 0;
               const orarioInizio = $("#orario-inizio").val();
               
               if (portata > 0 && quantita > 0 && orarioInizio) {
                   const durataOre = quantita / portata;
                   const durataMinuti = durataOre * 60;
                   
                   // Formatta durata
                   const ore = Math.floor(durataMinuti / 60);
                   const minuti = Math.round(durataMinuti % 60);
                   $("#durata-lavorazione").val(`${ore}h ${minuti}m`);
                   
                   // Calcola orario fine
                   const [oreInizio, minutiInizio] = orarioInizio.split(':').map(Number);
                   const inizioData = new Date();
                   inizioData.setHours(oreInizio, minutiInizio, 0, 0);
                   
                   const fineData = new Date(inizioData.getTime() + (durataMinuti * 60000));
                   const oreFine = fineData.getHours().toString().padStart(2, '0');
                   const minutiFine = fineData.getMinutes().toString().padStart(2, '0');
                   
                   $("#orario-fine").val(`${oreFine}:${minutiFine}`);
               }
           }

           function calcolaReseSpremitura() {
               const quantita = parseFloat($("#quantita-da-lavorare").val()) || 0;
               
               if (quantita > 0) {
                   const resaPrima = parseFloat($("#resa-prima-perc").val()) || 0;
                   const resaSeconda = parseFloat($("#resa-seconda-perc").val()) || 0;
                   const resaTorchiato = parseFloat($("#resa-torchiato-perc").val()) || 0;
                   
                   // Calcola litri (assumendo densità ~1 kg/L per semplicità)
                   const litriPrima = (quantita * resaPrima / 100);
                   const litriSeconda = (quantita * resaSeconda / 100);
                   const litriTorchiato = (quantita * resaTorchiato / 100);
                   
                   $("#resa-prima-litri").val(Math.round(litriPrima));
                   $("#resa-seconda-litri").val(Math.round(litriSeconda));
                   $("#resa-torchiato-litri").val(Math.round(litriTorchiato));
                   
                   // Totali
                   const totaleResa = litriPrima + litriSeconda + litriTorchiato;
                   const totalePerc = resaPrima + resaSeconda + resaTorchiato;
                   
                   $("#resa-totale").text(Math.round(totaleResa).toLocaleString('it-IT') + " L");
                   $("#resa-totale-perc").text(totalePerc.toFixed(1) + "%");
                   
                   // Auto-popola quantità destinazioni
                   $("#quantita-dest-prima").val(Math.round(litriPrima));
                   $("#quantita-dest-seconda").val(Math.round(litriSeconda));
                   $("#quantita-dest-torchiato").val(Math.round(litriTorchiato));
               }
           }

           // ================ GESTIONE FORNITORI ================
           function aggiungiFornitore() {
               fornitoreCounter++;
               const nuovoFornitore = `
                   <div class="fornitore-card" data-fornitore="${fornitoreCounter}">
                       <div class="row g-3 align-items-end">
                           <div class="col-md-3">
                               <label class="form-label form-label-required">Nome Fornitore</label>
                               <select class="form-select fornitore-select" required>
                                   <option value="">Seleziona fornitore</option>
                                   <option value="RESTUCCIA">RESTUCCIA</option>
                                   <option value="CI">CI</option>
                                   <option value="ARCO">ARCO</option>
                                   <option value="GIOVINAZZO">GIOVINAZZO</option>
                                   <option value="AZ.T.C.">AZ.T.C.</option>
                                   <option value="VASTA">VASTA</option>
                                   <option value="ALTRO">ALTRO</option>
                               </select>
                               <input type="text" class="form-control mt-2 altro-fornitore" placeholder="Specifica altro fornitore" style="display: none;">
                           </div>
                           <div class="col-md-2">
                               <label class="form-label form-label-required">Quantità (kg)</label>
                               <div class="input-group">
                                   <input type="number" class="form-control quantita-fornitore" min="0" required>
                                   <span class="input-group-text">kg</span>
                               </div>
                           </div>
                           <div class="col-md-3">
                               <label class="form-label form-label-required">Tipologia Prodotto</label>
                               <select class="form-select tipologia-prodotto" required>
                                   <option value="">Seleziona tipologia</option>
                                   <option value="BIO EU">BIO EU</option>
                                   <option value="BIO DEM">BIO DEM</option>
                                   <option value="BIO NTD">BIO NTD</option>
                                   <option value="TRACCIATO">TRACCIATO</option>
                                   <option value="IGP">IGP</option>
                                   <option value="CONVENZIONALE">CONVENZIONALE</option>
                                   <option value="ALTRO">ALTRO</option>
                               </select>
                               <input type="text" class="form-control mt-2 altra-tipologia" placeholder="Specifica altra tipologia" style="display: none;">
                           </div>
                           <div class="col-md-2">
                               <label class="form-label">Targa Mezzo</label>
                               <input type="text" class="form-control targa-mezzo" placeholder="AA123BB">
                           </div>
                           <div class="col-md-2">
                               <button type="button" class="btn btn-outline-danger btn-sm remove-fornitore">
                                   <i class="bi bi-trash"></i> Rimuovi
                               </button>
                           </div>
                       </div>
                   </div>
               `;
               
               $("#fornitori-container").append(nuovoFornitore);
               aggiornaCalculiFornitori();
           }

           function aggiornaCalculiFornitori() {
               let totaleFornitori = 0;
               
               $(".quantita-fornitore").each(function() {
                   const quantita = parseFloat($(this).val()) || 0;
                   totaleFornitori += quantita;
               });
               
               $("#totale-fornitori").text(totaleFornitori.toLocaleString('it-IT') + " kg");
               
               // Verifica differenza con entrata dichiarata
               const entrataGiornaliera = parseFloat($("#entrata-giornaliera").val()) || 0;
               const differenza = totaleFornitori - entrataGiornaliera;
               
               if (Math.abs(differenza) > 0) {
                   $("#differenza-alert").show();
                   const differenzaText = differenza > 0 ? 
                       `+${differenza.toLocaleString('it-IT')} kg (Eccesso)` : 
                       `${differenza.toLocaleString('it-IT')} kg (Deficit)`;
                   $("#differenza-valore").text(differenzaText);
                   
                   if (differenza > 0) {
                       $("#differenza-alert").removeClass("alert-warning").addClass("alert-danger");
                   } else {
                       $("#differenza-alert").removeClass("alert-danger").addClass("alert-warning");
                   }
               } else {
                   $("#differenza-alert").hide();
               }
               
               aggiornaProgressi();
               aggiornaRiepilogo();
           }

           // ================ AGGIORNAMENTO PROGRESSI ================
           function aggiornaProgressi() {
               // Calcola completamento configurazione
               let campiCompletati = 0;
               let campiTotali = 8;
               
               if ($("#data-lavorazione").val()) campiCompletati++;
               if ($("#turno").val()) campiCompletati++;
               if ($("#responsabile").val()) campiCompletati++;
               if ($("#tipo-agrume-principale").val()) campiCompletati++;
               if ($("#entrata-giornaliera").val()) campiCompletati++;
               if ($("#linea-trasformazione").val()) campiCompletati++;
               if ($("#portata-impianto").val()) campiCompletati++;
               if ($("#orario-inizio").val()) campiCompletati++;
               
               const progressConfig = Math.round((campiCompletati / campiTotali) * 100);
               $("#progress-config").css("width", progressConfig + "%").text(progressConfig + "%");
               
               // Calcola bilanciamento fornitori
               const entrataGiornaliera = parseFloat($("#entrata-giornaliera").val()) || 0;
               let totaleFornitori = 0;
               
               $(".quantita-fornitore").each(function() {
                   totaleFornitori += parseFloat($(this).val()) || 0;
               });
               
               let progressFornitori = 0;
               if (entrataGiornaliera > 0) {
                   progressFornitori = Math.min(100, Math.round((totaleFornitori / entrataGiornaliera) * 100));
               }
               
               $("#progress-fornitori").css("width", progressFornitori + "%").text(progressFornitori + "%");
               
               // Aggiorna stato sistema
               if (progressConfig >= 100 && progressFornitori >= 95 && progressFornitori <= 105) {
                   $("#stato-sistema").text("Pronto per lavorazione").removeClass().addClass("text-success fw-bold");
               } else if (progressConfig >= 70) {
                   $("#stato-sistema").text("Configurazione quasi completa").removeClass().addClass("text-warning fw-bold");
               } else {
                   $("#stato-sistema").text("In configurazione").removeClass().addClass("text-info fw-bold");
               }
           }

           // ================ AGGIORNAMENTO RIEPILOGO ================
           function aggiornaRiepilogo() {
               const riepilogoData = [
                   { parametro: "Data Lavorazione", valore: $("#data-lavorazione").val() || "Non impostata" },
                   { parametro: "Turno", valore: $("#turno").val() || "Non impostato" },
                   { parametro: "Responsabile", valore: $("#responsabile").val() || "Non impostato" },
                   { parametro: "Tipo Agrume", valore: $("#tipo-agrume-principale").val() || "Non selezionato" },
                   { parametro: "Varietà", valore: $("#varieta-agrume").val() || "Non selezionata" },
                   { parametro: "Quantità Totale", valore: $("#totale-disponibile").text() },
                   { parametro: "Linea Trasformazione", valore: $("#linea-trasformazione").val() || "Non selezionata" },
                   { parametro: "Portata Impianto", valore: ($("#portata-impianto").val() || "0") + " kg/h" },
                   { parametro: "Orario Inizio", valore: $("#orario-inizio").val() || "Non impostato" },
                   { parametro: "Durata Stimata", valore: $("#durata-lavorazione").val() || "Non calcolata" },
                   { parametro: "Resa Totale Stimata", valore: $("#resa-totale").text() }
               ];
               
               const tbody = $("#riepilogo-table");
               tbody.empty();
               
               riepilogoData.forEach(function(item) {
                   const row = `
                       <tr>
                           <td><strong>${item.parametro}</strong></td>
                           <td>${item.valore}</td>
                       </tr>
                   `;
                   tbody.append(row);
               });
           }

           // ================ GESTIONE DESTINAZIONI ================
           function gestisciDestinazioni() {
               $(".destinazione-select").change(function() {
                   const container = $(this).closest('.col-md-4');
                   const altraDestInput = container.find('.altra-dest');
                   
                   if ($(this).val() === "ALTRO") {
                       altraDestInput.show().attr('required', true);
                   } else {
                       altraDestInput.hide().removeAttr('required').val('');
                   }
               });
           }

           // ================ CARICAMENTO DATI DEMO ================
           function caricaDatiDemo() {
               // Dati demo configurazione
               $("#responsabile").val("Marco Russo");
               $("#note-giornata").val("Lavorazione prioritaria limoni per cliente tedesco");
               
               // Dati demo agrume
               $("#tipo-agrume-principale").val("LIMONE").trigger('change');
               setTimeout(function() {
                   $("#varieta-agrume").val("Verdello");
               }, 100);
               
               // Dati demo giacenze
               $("#giacenza-totale").val("15000");
               $("#entrata-giornaliera").val("8000");
               
               // Dati demo lavorazione
               $("#linea-trasformazione").val("BOE/1100");
               $("#portata-impianto").val("2500");
               $("#quantita-da-lavorare").val("8000");
               $("#orario-inizio").val("08:00");
               
               // Aggiorna calcoli
               setTimeout(function() {
                   calcolaQuantitaTotale();
                   calcolaDurataLavorazione();
                   calcolaReseSpremitura();
                   aggiornaProgressi();
                   aggiornaRiepilogo();
               }, 200);
               
               // Carica storico demo
               caricaStoricoDemo();
               
               console.log("Dati demo caricati");
           }

           function caricaStoricoDemo() {
               const storicoDemo = [
                   {
                       data: "2025-05-21",
                       turno: "Mattino",
                       agrume: "ARANCIA",
                       quantita: 7500,
                       linea: "GOE EST/400",
                       durata: "3h 15m",
                       resa: 78.5,
                       stato: "Completato"
                   },
                   {
                       data: "2025-05-20",
                       turno: "Pomeriggio",
                       agrume: "LIMONE",
                       quantita: 6200,
                       linea: "B/SF",
                       durata: "2h 45m",
                       resa: 82.1,
                       stato: "Completato"
                   },
                   {
                       data: "2025-05-20",
                       turno: "Mattino",
                       agrume: "MANDARINO",
                       quantita: 5800,
                       linea: "GOE INT/POLY",
                       durata: "2h 30m",
                       resa: 75.3,
                       stato: "Completato"
                   }
               ];
               
               const tbody = $("#storico-table");
               tbody.empty();
               
               storicoDemo.forEach(function(item, index) {
                   const statoClass = item.stato === "Completato" ? "text-success" : "text-warning";
                   const row = `
                       <tr>
                           <td>${item.data}</td>
                           <td>${item.turno}</td>
                           <td><strong>${item.agrume}</strong></td>
                           <td>${item.quantita.toLocaleString('it-IT')} kg</td>
                           <td>${item.linea}</td>
                           <td>${item.durata}</td>
                           <td>${item.resa}%</td>
                           <td><span class="fw-bold ${statoClass}">${item.stato}</span></td>
                           <td>
                               <button class="btn btn-sm btn-outline-primary" onclick="visualizzaDettagli(${index})">
                                   <i class="bi bi-eye"></i> Dettagli
                               </button>
                           </td>
                       </tr>
                   `;
                   tbody.append(row);
               });
           }

           // ================ EVENT LISTENERS ================
           
           // Calcoli automatici
           $("#giacenza-totale, #entrata-giornaliera").on('input', calcolaQuantitaTotale);
           $("#portata-impianto, #quantita-da-lavorare, #orario-inizio").on('input change', calcolaDurataLavorazione);
           $("#resa-prima-perc, #resa-seconda-perc, #resa-torchiato-perc").on('input', calcolaReseSpremitura);
           
           // Gestione fornitori
           $("#add-fornitore").click(aggiungiFornitore);
           $(document).on('click', '.remove-fornitore', function() {
               if ($('.fornitore-card').length > 1) {
                   $(this).closest('.fornitore-card').remove();
                   aggiornaCalculiFornitori();
               } else {
                   alert("Deve rimanere almeno un fornitore!");
               }
           });
           
           $(document).on('change', '.fornitore-select', function() {
               const container = $(this).closest('.fornitore-card');
               const altroInput = container.find('.altro-fornitore');
               
               if ($(this).val() === "ALTRO") {
                   altroInput.show().attr('required', true);
               } else {
                   altroInput.hide().removeAttr('required').val('');
               }
           });
           
           $(document).on('change', '.tipologia-prodotto', function() {
               const container = $(this).closest('.fornitore-card');
               const altraInput = container.find('.altra-tipologia');
               
               if ($(this).val() === "ALTRO") {
                   altraInput.show().attr('required', true);
               } else {
                   altraInput.hide().removeAttr('required').val('');
               }
               
               // Evidenzia righe BIO
               if ($(this).val().includes('BIO')) {
                   container.addClass('bio-row');
               } else {
                   container.removeClass('bio-row');
               }
           });
           
           $(document).on('input', '.quantita-fornitore', aggiornaCalculiFornitori);
           
           // Aggiorna tutti i progressi quando cambiano i campi
           $("input, select").on('change input', function() {
               aggiornaProgressi();
               aggiornaRiepilogo();
           });
           
           // Gestione destinazioni
           gestisciDestinazioni();
           
           // ================ PULSANTI AZIONE ================
           
           $("#btn-salva-programma").click(function() {
               const programmaJson = JSON.stringify(raccogliDatiProgramma(), null, 2);
               console.log("Programma salvato:", programmaJson);
               
               // Simula salvataggio
               const timestamp = new Date().toLocaleString('it-IT');
               alert(`Programma salvato con successo!\nTimestamp: ${timestamp}\n\nIl programma è stato salvato nel sistema.`);
               
               // Aggiorna stato
               programmaData.stato = 'salvato';
               $("#stato-sistema").text("Programma salvato").removeClass().addClass("text-primary fw-bold");
           });
           
           $("#btn-avvia-lavorazione").click(function() {
               if (validaProgramma()) {
                   mostraConferma(
                       "Avvio Lavorazione",
                       "Confermi l'avvio della lavorazione? Una volta avviata, il programma non potrà essere modificato.",
                       function() {
                           avviaLavorazione();
                       }
                   );
               } else {
                   alert("Completare tutti i campi obbligatori prima di avviare la lavorazione!");
               }
           });
           
           $("#btn-reset-programma").click(function() {
               mostraConferma(
                   "Reset Programma",
                   "ATTENZIONE: Questa operazione cancellerà tutti i dati inseriti. L'operazione non può essere annullata.",
                   function() {
                       resetProgramma();
                   }
               );
           });
           
           $("#btn-carica-template").click(function() {
               mostraConferma(
                   "Carica Template",
                   "Vuoi caricare un template predefinito? I dati attuali saranno sovrascritti.",
                   function() {
                       caricaTemplate();
                   }
               );
           });
           
           $("#btn-export-pdf").click(function() {
               alert("Funzione di esportazione PDF in sviluppo...");
           });
           
           $("#btn-print").click(function() {
               window.print();
           });
           
           // ================ FUNZIONI UTILITY ================
           
           function raccogliDatiProgramma() {
               const config = {
                   data: $("#data-lavorazione").val(),
                   turno: $("#turno").val(),
                   responsabile: $("#responsabile").val(),
                   note: $("#note-giornata").val()
               };
               
               const agrume = {
                   tipo: $("#tipo-agrume-principale").val(),
                   varieta: $("#varieta-agrume").val(),
                   giacenza: parseFloat($("#giacenza-totale").val()) || 0,
                   entrata: parseFloat($("#entrata-giornaliera").val()) || 0
               };
               
               const fornitori = [];
               $(".fornitore-card").each(function() {
                   const card = $(this);
                   const fornitore = {
                       nome: card.find(".fornitore-select").val(),
                       altroNome: card.find(".altro-fornitore").val(),
                       quantita: parseFloat(card.find(".quantita-fornitore").val()) || 0,
                       tipologia: card.find(".tipologia-prodotto").val(),
                       altraTipologia: card.find(".altra-tipologia").val(),
                       targa: card.find(".targa-mezzo").val()
                   };
                   if (fornitore.nome && fornitore.quantita > 0) {
                       fornitori.push(fornitore);
                   }
               });
               
               const lavorazione = {
                   linea: $("#linea-trasformazione").val(),
                   portata: parseFloat($("#portata-impianto").val()) || 0,
                   quantita: parseFloat($("#quantita-da-lavorare").val()) || 0,
                   orarioInizio: $("#orario-inizio").val(),
                   durata: $("#durata-lavorazione").val(),
                   orarioFine: $("#orario-fine").val()
               };
               
               const rese = {
                   prima: {
                       percentuale: parseFloat($("#resa-prima-perc").val()) || 0,
                       litri: parseFloat($("#resa-prima-litri").val()) || 0,
                       effettiva: parseFloat($("#resa-prima-effettiva").val()) || 0
                   },
                   seconda: {
                       percentuale: parseFloat($("#resa-seconda-perc").val()) || 0,
                       litri: parseFloat($("#resa-seconda-litri").val()) || 0,
                       effettiva: parseFloat($("#resa-seconda-effettiva").val()) || 0
                   },
                   torchiato: {
                       percentuale: parseFloat($("#resa-torchiato-perc").val()) || 0,
                       litri: parseFloat($("#resa-torchiato-litri").val()) || 0,
                       effettiva: parseFloat($("#resa-torchiato-effettiva").val()) || 0
                   }
               };
               
               const destinazioni = {
                   prima: {
                       destinazione: $("#dest-prima").val(),
                       quantita: parseFloat($("#quantita-dest-prima").val()) || 0
                   },
                   seconda: {
                       destinazione: $("#dest-seconda").val(),
                       quantita: parseFloat($("#quantita-dest-seconda").val()) || 0
                   },
                   torchiato: {
                       destinazione: $("#dest-torchiato").val(),
                       quantita: parseFloat($("#quantita-dest-torchiato").val()) || 0
                   }
               };
               
               return {
                   timestamp: new Date().toISOString(),
                   config: config,
                   agrume: agrume,
                   fornitori: fornitori,
                   lavorazione: lavorazione,
                   rese: rese,
                   destinazioni: destinazioni,
                   stato: programmaData.stato
               };
           }
           
           function validaProgramma() {
               const campiObbligatori = [
                   "#data-lavorazione",
                   "#turno", 
                   "#responsabile",
                   "#tipo-agrume-principale",
                   "#entrata-giornaliera",
                   "#linea-trasformazione",
                   "#portata-impianto",
                   "#quantita-da-lavorare",
                   "#orario-inizio"
               ];
               
               let valido = true;
               
               campiObbligatori.forEach(function(campo) {
                   if (!$(campo).val()) {
                       $(campo).addClass("is-invalid");
                       valido = false;
                   } else {
                       $(campo).removeClass("is-invalid");
                   }
               });
               
               // Verifica fornitori
               let fornitoriValidi = true;
               $(".fornitore-card").each(function() {
                   const nome = $(this).find(".fornitore-select").val();
                   const quantita = $(this).find(".quantita-fornitore").val();
                   const tipologia = $(this).find(".tipologia-prodotto").val();
                   
                   if (!nome || !quantita || !tipologia) {
                       $(this).find(".form-control, .form-select").addClass("is-invalid");
                       fornitoriValidi = false;
                   }
               });
               
               return valido && fornitoriValidi;
           }
           
           function avviaLavorazione() {
               // Simula avvio lavorazione
               const orarioInizio = new Date().toLocaleTimeString('it-IT');
               programmaData.stato = 'in_lavorazione';
               
               $("#stato-sistema").text(`Lavorazione avviata alle ${orarioInizio}`).removeClass().addClass("text-success fw-bold");
               
               // Disabilita tutti i campi
               $("input, select").prop('disabled', true);
               $(".btn-programma, .btn-outline-success, .btn-outline-warning").prop('disabled', true);
               
               alert(`Lavorazione avviata con successo!\nOrario inizio: ${orarioInizio}\n\nTutti i parametri sono ora bloccati.`);
               
               // Simula aggiornamento stato
               simulaAvanzamentoLavorazione();
           }
           
           function simulaAvanzamentoLavorazione() {
               let progresso = 0;
               const intervallo = setInterval(function() {
                   progresso += Math.random() * 5;
                   
                   if (progresso >= 100) {
                       progresso = 100;
                       clearInterval(intervallo);
                       $("#stato-sistema").text("Lavorazione completata").removeClass().addClass("text-success fw-bold");
                       
                       // Salva nei dati storici
                       salvaInStorico();
                   }
                   
                   $("#stato-sistema").text(`Lavorazione in corso: ${Math.round(progresso)}%`);
               }, 2000);
           }
           
           function salvaInStorico() {
               const nuovoRecord = {
                   data: $("#data-lavorazione").val(),
                   turno: $("#turno").val().split(' ')[0],
                   agrume: $("#tipo-agrume-principale").val(),
                   quantita: parseInt($("#quantita-da-lavorare").val()),
                   linea: $("#linea-trasformazione").val(),
                   durata: $("#durata-lavorazione").val(),
                   resa: (parseFloat($("#resa-prima-perc").val()) + parseFloat($("#resa-seconda-perc").val()) + parseFloat($("#resa-torchiato-perc").val())).toFixed(1),
                   stato: "Completato"
               };
               
               // Aggiungi in cima alla tabella
               const statoClass = "text-success";
               const row = `
                   <tr class="table-success">
                       <td><strong>${nuovoRecord.data}</strong></td>
                       <td>${nuovoRecord.turno}</td>
                       <td><strong>${nuovoRecord.agrume}</strong></td>
                       <td>${nuovoRecord.quantita.toLocaleString('it-IT')} kg</td>
                       <td>${nuovoRecord.linea}</td>
                       <td>${nuovoRecord.durata}</td>
                       <td>${nuovoRecord.resa}%</td>
                       <td><span class="fw-bold ${statoClass}">${nuovoRecord.stato}</span></td>
                       <td>
                           <button class="btn btn-sm btn-outline-primary">
                               <i class="bi bi-eye"></i> Dettagli
                           </button>
                       </td>
                   </tr>
               `;
               
               $("#storico-table").prepend(row);
           }
           
           function resetProgramma() {
               // Reset completo del form
               $("form")[0].reset();
               $("#config-form")[0].reset();
               
               // Reset campi calcolati
               $(".calculated-field").val("");
               $("#totale-disponibile").text("0 kg");
               $("#resa-totale").text("0 L");
               $("#resa-totale-perc").text("0%");
               $("#totale-fornitori").text("0 kg");
               $("#differenza-alert").hide();
               
               // Reset fornitori (mantieni solo il primo)
               $(".fornitore-card:not(:first)").remove();
               $(".fornitore-card:first input, .fornitore-card:first select").val("");
               $(".altro-fornitore, .altra-tipologia").hide();
               
               // Reset progressi
               $("#progress-config, #progress-fornitori").css("width", "0%").text("0%");
               $("#stato-sistema").text("In configurazione").removeClass().addClass("text-info fw-bold");
               
               // Reset destinazioni
               $(".altra-dest").hide().val("");
               
               // Riabilita campi se erano disabilitati
               $("input, select, button").prop('disabled', false);
               
               // Reset variabili
               programmaData.stato = 'configurazione';
               fornitoreCounter = 1;
               
               alert("Programma resettato con successo!");
           }
           
           function caricaTemplate() {
               const templates = {
                   "limoni": {
                       agrume: "LIMONE",
                       varieta: "Verdello",
                       linea: "B/SF",
                       portata: 2200,
                       resaPrima: 48,
                       resaSeconda: 28,
                       resaTorchiato: 16
                   },
                   "arance": {
                       agrume: "ARANCIA",
                       varieta: "Tarocco",
                       linea: "GOE EST/400",
                       portata: 2800,
                       resaPrima: 42,
                       resaSeconda: 25,
                       resaTorchiato: 18
                   },
                   "mandarini": {
                       agrume: "MANDARINO",
                       varieta: "Ciaculli",
                       linea: "GOE INT/POLY",
                       portata: 2000,
                       resaPrima: 38,
                       resaSeconda: 22,
                       resaTorchiato: 15
                   }
               };
               
               // Chiedi quale template caricare
               const scelta = prompt("Seleziona template:\n1. Limoni\n2. Arance\n3. Mandarini\n\nInserisci il numero:");
               
               let templateScelto;
               switch(scelta) {
                   case "1":
                       templateScelto = templates.limoni;
                       break;
                   case "2":
                       templateScelto = templates.arance;
                       break;
                   case "3":
                       templateScelto = templates.mandarini;
                       break;
                   default:
                       alert("Selezione non valida!");
                       return;
               }
               
               // Applica template
               $("#tipo-agrume-principale").val(templateScelto.agrume).trigger('change');
               setTimeout(function() {
                   $("#varieta-agrume").val(templateScelto.varieta);
                   $("#linea-trasformazione").val(templateScelto.linea);
                   $("#portata-impianto").val(templateScelto.portata);
                   $("#resa-prima-perc").val(templateScelto.resaPrima);
                   $("#resa-seconda-perc").val(templateScelto.resaSeconda);
                   $("#resa-torchiato-perc").val(templateScelto.resaTorchiato);
                   
                   // Ricalcola tutto
                   calcolaQuantitaTotale();
                   calcolaDurataLavorazione();
                   calcolaReseSpremitura();
                   aggiornaProgressi();
                   aggiornaRiepilogo();
               }, 200);
               
               alert(`Template "${templateScelto.agrume}" caricato con successo!`);
           }
           
           function mostraConferma(titolo, messaggio, callback) {
               $("#confirmModalLabel").text(titolo);
               $("#confirmModalBody").html(`<p>${messaggio}</p>`);
               
               $("#confirmActionBtn").off('click').on('click', function() {
                   callback();
                   bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
               });
               
               new bootstrap.Modal(document.getElementById('confirmModal')).show();
           }
           
           // Funzione globale per dettagli storici
           window.visualizzaDettagli = function(index) {
               alert(`Dettagli lavorazione non ancora implementati.\nIndice: ${index}`);
           };
           
           // ================ INIZIALIZZAZIONE FINALE ================
           
           // Avvia inizializzazione
           inizializzaInterface();
           
           // Aggiorna riepilogo iniziale
           setTimeout(function() {
               aggiornaRiepilogo();
           }, 500);
           
           console.log("Programma Giornaliero Lavorazione Frutta - Inizializzazione completata!");
       });
   </script>
</body>
</html>
